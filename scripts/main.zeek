module CVE_2022_30216_Detection;

@load base/protocols/dce-rpc
@load base/frameworks/notice

export {
	redef enum Notice::Type += {
		CVE_2022_30216_Attempt
	};
}

event dce_rpc_request(c: connection, fid: count, ctx_id: count, opnum: count,
                      stub_len: count)
	{
	if ( opnum != 74 || ! c?$dce_rpc || ! c$dce_rpc?$endpoint )
		return;

	if ( c$dce_rpc$endpoint == "srvsvc" )
		NOTICE([$note=CVE_2022_30216_Attempt, $conn=c, 
			$msg=fmt("Potential CVE-2022-30216 exploit attempt: %s attempted exploit against %s", 
				 c$id$orig_h, c$id$resp_h),
			$identifier=cat(c$id$orig_h, c$id$resp_h)]);
	}
